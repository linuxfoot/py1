    - name: 1. Download depend
      get_url:
       url: http://springdale.math.ias.edu/data/puias/unsupported/7/x86_64/iksemel-1.4-6.sdl7.x86_64.rpm
       dest: /tmp/iksemel-1.4-6.sdl7.x86_64.rpm
    
    - name: 1.1 Install depend
      yum:
       name: /tmp/iksemel-1.4-6.sdl7.x86_64.rpm
       state: installed 

    - name: 1.2 Config zabbix_repo
      template:
       src: zabbix.j2
       dest: /etc/yum.repos.d/zabbix.repo

    - name: 1.3 Get Ready
      command: 'yum clean all'

    - name: 1.4 Install all
      yum:
       name: '{{ item }}' 
       state: installed
      loop:
        - zabbix-server-mysql 
        - zabbix-web-mysql 
        - mariadb-server
        - python-pip

    - name: 1.5 Install PyMySql and pexpect
      pip: 
       name: '{{ item }}'
      loop:
       - PyMySql
       - pexpect
       
    - name: 02. Start DB
      systemd:
        name: mariadb
        state: started
        enabled: yes

    - name: 03. DB Initialization
      expect:
       command: mysql_secure_installation
       responses:
        just press enter here: "\n"
        Set root password: "Y"
        New password: "1234"
        Re-enter new password: "1234"
        Remove anonymous users: "Y"
        Disallow root login remotely: "N"
        Remove test database and access to it: "Y"
        Reload privilege tables now: "Y"

    - name: 04. Create DB 
      mysql_db:
       name:
        - zabbix
       state: present 
       encoding: utf8
       login_user: root
       login_password: "1234"

    - name: 05. Create DB users
      mysql_user:
       name: zabbixer
       host: localhost
       priv: zabbix.*:ALL
       password: "123456"
       login_user: root
       login_password: "1234"


    - name: 05.1 Config DB
      script: comm.sh

    - name: 06. Config conf
      lineinfile:
       path: /etc/zabbix/zabbix_server.conf
       regexp: '{{ item.if }}'
       line: '{{ item.info }}'
      loop:
       - { if: 'DBHost=', info: 'DBHost=localhost' }
       - { if: 'DBName=', info: 'DBName=zabbix' }
       - { if: 'DBUser=', info: 'DBUser=zabbixer' }
       - { if: 'DBPassword=', info: 'DBPassword=123456' }

    - name: 07. Config php
      lineinfile:
       path: /etc/php.ini 
       regexp: 'date.timezone'
       line: date.timezone = Asia/Shanghai

    - name: 08. Systemd
      systemd:
        name: '{{ item }}'
        state: started
        enabled: yes
      loop:
       - zabbix-server 
       - httpd
       - mariadb
